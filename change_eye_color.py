from openai import OpenAI
import requests
from PIL import Image
import os
import time

# ============= CONFIGURATION - EDIT HERE =============
API_KEY = r"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"
IMAGE_PATH = r"tryIn\000003.jpg"
# Use the mask generated by the eye circles masking function (Eyes=Black, Rest=White)
MASK_PATH = r"tryOut\000003_eye_circles_mask.jpg"
NEW_EYE_COLOR = "bright green eyes" 
OUTPUT_PATH = r"tryOut\000003_edited_eyes.png"
# =====================================================

def prepare_mask(mask_path):
    """
    Converts Black/White mask to Transparent/Opaque RGBA for OpenAI API.
    Black (Eyes) -> Transparent (Alpha 0) -> Area to be edited
    White (Rest) -> Opaque (Alpha 255) -> Area to keep original
    """
    print(f"Preparing edit mask from: {mask_path}")
    with Image.open(mask_path).convert("L") as mask:
        w, h = mask.size
        new_mask = Image.new("RGBA", (w, h), (255, 255, 255, 255))
        
        for y in range(h):
            for x in range(w):
                value = mask.getpixel((x, y))
                if value < 100:  # The black area detected as eyes
                    new_mask.putpixel((x, y), (255, 255, 255, 0)) # Transparent (edit area)
                else:
                    new_mask.putpixel((x, y), (255, 255, 255, 255)) # Opaque (keep original)
        
        new_path = os.path.splitext(mask_path)[0] + "_eye_editmask.png"
        new_mask.save(new_path, "PNG")
    return new_path

def convert_image_to_rgba(image_path):
    with Image.open(image_path) as img:
        img = img.convert("RGBA")
        new_path = os.path.splitext(image_path)[0] + "_rgba_temp.png"
        img.save(new_path, "PNG")
    return new_path

def change_eye_color(image_path, mask_path, new_color, output_path):
    client = OpenAI(api_key=API_KEY)
    image_temp = None
    mask_temp = None

    try:
        image_temp = convert_image_to_rgba(image_path)
        mask_temp = prepare_mask(mask_path)

        print(f"\nSending Eye Color Edit request: {new_color}...")

        with open(image_temp, "rb") as img_file, open(mask_temp, "rb") as mask_file:
            response = client.images.edit(
                model="dall-e-2",
                image=img_file,
                mask=mask_file,
                prompt=f"Photorealistic edit. Change ONLY the eye color to {new_color}. Keep skin, face, lighting, and photo identical.",
                size="1024x1024"
            )

        image_url = response.data[0].url
        img_data = requests.get(image_url, timeout=30).content
        with open(output_path, "wb") as f:
            f.write(img_data)

        print(f"✅ Success! Saved to: {output_path}")
        return output_path

    except Exception as e:
        print(f"❌ Error: {e}")
        return None
    finally:
        # Cleanup temp files
        for f in [image_temp, mask_temp]:
            if f and os.path.exists(f):
                try: os.remove(f)
                except: pass

if __name__ == "__main__":
    change_eye_color(IMAGE_PATH, MASK_PATH, NEW_EYE_COLOR, OUTPUT_PATH)
